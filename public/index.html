<!DOCTYPE html>
<html>
<head>
    <title>InstantHelp Mini App</title>
    <meta charset="UTF-8" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
    <div class="container my-3 text-center">
        <!-- Кнопки для переключения -->
        <button class="btn btn-secondary me-2" onclick="showHelp()">Нужна помощь</button>
        <button class="btn btn-secondary" onclick="showHelpOffer()">Готов помочь</button>
    </div>

    <!-- Контейнер для запроса помощи -->
    <div id="helpContainer" class="container my-4" style="display:none;">
        <h3>Нужна помощь? Опиши проблему:</h3>
        <textarea id="desc" class="form-control" rows="4" placeholder="Например: не включается ноутбук..."></textarea>
        <button class="btn btn-primary mt-3" onclick="send()">Отправить</button>
        <!-- Индикатор загрузки -->
        <div id="loadingHelp" class="mt-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div> Отправка...
        </div>
        <div id="result" class="mt-3" style="display:none; white-space: pre-wrap;"></div>
    </div>

    <!-- Контейнер для предложения помощи -->
    <div id="offerContainer" class="container my-4" style="display:none;">
        <h3>Готов помочь? Опиши, чем можете помочь:</h3>
        <textarea id="offerDesc" class="form-control" rows="4" placeholder="Например: могу помочь с настройкой..."></textarea>
        <button class="btn btn-success mt-3" onclick="offerHelp()">Отправить предложение</button>
        <div id="offerResult" class="mt-3" style="display:none; white-space: pre-wrap;"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        function showHelp() {
            document.getElementById('helpContainer').style.display = 'block';
            document.getElementById('offerContainer').style.display = 'none';
        }

        function showHelpOffer() {
            document.getElementById('helpContainer').style.display = 'none';
            document.getElementById('offerContainer').style.display = 'block';
        }

        function send() {
            // Показываем индикатор ожидания
            document.getElementById('loadingHelp').style.display = 'block';
            // Очищаем результат
            document.getElementById('result').style.display = 'none';

            fetch("https://hmdi-api.onrender.com/request-help", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    user: tg.initDataUnsafe.user,
                    description: document.getElementById("desc").value
                })
            })
            .then(res => res.json())
            .then(data => {
                // Скрываем индикатор
                document.getElementById('loadingHelp').style.display = 'none';
                // Показываем результат
                const result = document.getElementById("result");
                result.style.display = "block";
                result.innerText = data.message;
            })
            .catch(e => {
                document.getElementById('loadingHelp').style.display = 'none';
                alert("Ошибка: " + e);
            });
        }

        function offerHelp() {
            fetch("https://hmdi-api.onrender.com/offer-help", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    user: tg.initDataUnsafe.user,
                    description: document.getElementById("offerDesc").value
                })
            })
            .then(res => res.json())
            .then(data => {
                const result = document.getElementById("offerResult");
                result.style.display = "block";
                result.innerText = data.message;
            })
            .catch(e => alert("Ошибка: " + e));
        }
    </script>
</body>
</html>