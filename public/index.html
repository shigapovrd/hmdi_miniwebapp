<!DOCTYPE html>
<html>

<head>
    <title>Help Me Do It</title>
    <meta charset="UTF-8" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        .action-btn {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 24px;
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }
        .action-btn i {
            color: white;
        }
        #jitsiContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background: white;
        }
        .close-video {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>

<body>
    <div id="jitsiContainer">
        <button class="btn-close close-video" onclick="closeVideoCall()" aria-label="Close"></button>
    </div>
    <div class="container my-3 text-center">
        <button class="btn btn-secondary me-2" onclick="showHelp()">Нужна помощь</button>
        <button class="btn btn-secondary" onclick="showHelpOffer()">Готовы помочь</button>
    </div>

    <div id="helpContainer" class="container my-4" style="display:none;">
        <h3>Нужна помощь? Опишите проблему:</h3>
        <textarea id="desc" class="form-control" rows="4" placeholder="Например: не включается ноутбук..."></textarea>
        <button class="btn btn-primary mt-3" onclick="send()">Отправить</button>
        <div id="loadingHelp" class="mt-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div> Отправка...
        </div>
        <div id="result" class="mt-3" style="display:none; white-space: pre-wrap;"></div>
    </div>

    <div id="offerContainer" class="container my-4" style="display:none;">
        <div id="selectedRequest" class="card mb-3 w-100" style="display:none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-3">Детали заявки</h5>
                        <p class="card-text" id="selectedRequestDesc"></p>
                    </div>
                    <button type="button" class="btn-close" aria-label="Close" onclick="closeRequestCard()"></button>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary action-btn" onclick="respondWithTelegram()" title="Написать в Telegram">
                        <i class="bi bi-telegram"></i>
                    </button>
                    <button class="btn btn-success action-btn" onclick="respondWithChat()" title="Открыть чат">
                        <i class="bi bi-chat-dots"></i>
                    </button>
                    <button class="btn btn-info action-btn" onclick="respondWithVideoCall()" title="Видеозвонок">
                        <i class="bi bi-camera-video"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <h4>Нужна помощь:</h4>
            <div id="loadingRequests" class="text-center mb-3" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка заявок...</span>
                </div>
                <div>Загрузка заявок...</div>
            </div>
            <div class="list-group px-0">
                <div id="selectedRequest" class="card mb-3" style="display:none;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-3">Детали заявки</h5>
                                <p class="card-text mb-0" id="selectedRequestDesc"></p>
                            </div>
                            <button type="button" class="btn-close" aria-label="Close" onclick="closeRequestCard()"></button>
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-primary action-btn" onclick="respondWithTelegram()" title="Написать в Telegram">
                                <i class="bi bi-telegram"></i>
                            </button>
                            <button class="btn btn-success action-btn" onclick="respondWithChat()" title="Открыть чат">
                                <i class="bi bi-chat-dots"></i>
                            </button>
                            <button class="btn btn-info action-btn" onclick="respondWithVideoCall()" title="Видеозвонок">
                                <i class="bi bi-camera-video"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="helpRequests">
                            <!-- Здесь будут появляться заявки -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Генерация user_id при запуске
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 8);
        }

        // Функция для получения user_id из Telegram storage
        async function initUserId() {
            try {
                const userData = await tg.CloudStorage.getItem('hmdi_user_id');
                if (!userData) {
                    const newUserId = generateUserId();
                    await tg.CloudStorage.setItem('hmdi_user_id', newUserId);
                    localStorage.setItem('hmdi_user_id', newUserId);
                    return newUserId;
                }
                localStorage.setItem('hmdi_user_id', userData);
                return userData;
            } catch (error) {
                console.error('Error accessing CloudStorage:', error);
                // Fallback to localStorage if CloudStorage is not available
                let userId = localStorage.getItem('hmdi_user_id');
                if (!userId) {
                    userId = generateUserId();
                    localStorage.setItem('hmdi_user_id', userId);
                }
                return userId;
            }
        }

        // Инициализация user_id при загрузке
        initUserId().then(() => {
            // После получения user_id можно загружать данные если нужно
            if (document.getElementById('offerContainer').style.display !== 'none') {
                loadHelpRequests();
            }
        });

        function showHelp() {
            document.getElementById('helpContainer').style.display = 'block';
            document.getElementById('offerContainer').style.display = 'none';
        }

        let isLoading = false;

        function showHelpOffer() {
            document.getElementById('helpContainer').style.display = 'none';
            document.getElementById('offerContainer').style.display = 'block';
            if (!isLoading) {
                loadHelpRequests();
            }
        }

        function send() {
            const description = document.getElementById("desc").value.trim();
            
            if (!description) {
                const result = document.getElementById("result");
                result.style.display = "block";
                result.className = "alert alert-warning mt-3";
                result.innerText = "Пожалуйста, опишите вашу проблему";
                return;
            }

            document.getElementById('loadingHelp').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            fetch("https://hmdi-api.onrender.com/request-help", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    user_id: localStorage.getItem('hmdi_user_id'),
                    description: description
                })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loadingHelp').style.display = 'none';
                const result = document.getElementById("result");
                result.style.display = "block";
                result.className = "alert alert-success mt-3";
                result.innerText = data.message;
            })
            .catch(e => {
                document.getElementById('loadingHelp').style.display = 'none';
                const result = document.getElementById("result");
                result.style.display = "block";
                result.className = "alert alert-danger mt-3";
                result.innerText = "Ошибка: " + e;
            });
        }

        function offerHelp() {
            fetch("https://hmdi-api.onrender.com/offer-help", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user: tg.initDataUnsafe.user,
                    description: document.getElementById("offerDesc").value
                })
            })
                .then(res => res.json())
                .then(data => {
                    const result = document.getElementById("offerResult");
                    result.style.display = 'block';
                    result.innerText = data.message;
                })
                .catch(e => alert("Ошибка: " + e));
        }

        let selectedRequestData = null;

        function showRequestCard(request) {
            selectedRequestData = request;
            const cardElement = document.getElementById('selectedRequest');
            const descElement = document.getElementById('selectedRequestDesc');

            descElement.innerText = request.description;
            cardElement.style.display = 'block';

            // Плавно прокручиваем к карточке
            cardElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeRequestCard() {
            document.getElementById('selectedRequest').style.display = 'none';
            selectedRequestData = null;
        }

        function respondWithTelegram() {
            if (!selectedRequestData) return;
            tg.showAlert('Открываем Telegram чат...');
            // Здесь будет логика для открытия Telegram чата
        }

        function respondWithChat() {
            if (!selectedRequestData) return;
            tg.showAlert('Открываем чат...');
            // Здесь будет логика для открытия чата
        }

        let jitsiApi = null;

        function respondWithVideoCall() {
            if (!selectedRequestData) return;
            
            const container = document.getElementById('jitsiContainer');
            const userId = localStorage.getItem('hmdi_user_id');

            // Проверяем, не пытается ли пользователь помочь сам себе
            if (selectedRequestData.user_id === userId) {
                tg.showAlert('Вы не можете помогать с собственной заявкой');
                return;
            }
            
            // Создаем видео-комнату
            fetch("https://hmdi-api.onrender.com/create-video-room", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    ticket_id: selectedRequestData.ticket_id,
                    helper_id: userId
                })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Ошибка создания видеозвонка');
                }
                return res.json();
            })
            .then(data => {
                if (data.error) {
                    if (data.status === 'self_help_forbidden') {
                        tg.showAlert('Вы не можете помогать с собственной заявкой');
                    } else {
                        tg.showAlert(data.error);
                    }
                    return;
                }

                container.style.display = 'block';
                
                const options = {
                    roomName: data.room_id,
                    width: '100%',
                    height: '100%',
                    parentNode: container,
                    lang: 'ru',
                    configOverwrite: {
                        prejoinPageEnabled: false,
                        startWithAudioMuted: true,
                        startWithVideoMuted: true
                    },
                    interfaceConfigOverwrite: {
                        TOOLBAR_BUTTONS: [
                            'microphone', 'camera', 'closedcaptions', 'desktop',
                            'fullscreen', 'fodeviceselection', 'hangup', 'chat',
                            'settings', 'raisehand', 'videoquality', 'filmstrip',
                            'shortcuts', 'tileview'
                        ],
                        SHOW_JITSI_WATERMARK: false,
                        SHOW_WATERMARK_FOR_GUESTS: false,
                        SHOW_BRAND_WATERMARK: false
                    }
                };

                jitsiApi = new JitsiMeetExternalAPI(data.domain, options);
                
                // Обработчики событий
                jitsiApi.addEventListeners({
                    readyToClose: () => {
                        closeVideoCall(data.room_id, userId);
                    },
                    videoConferenceLeft: () => {
                        closeVideoCall(data.room_id, userId);
                    }
                });

                // Периодически проверяем статус комнаты
                const roomCheckInterval = setInterval(async () => {
                    try {
                        const response = await fetch(
                            `https://hmdi-api.onrender.com/check-video-room/${data.room_id}?user_id=${userId}`
                        );
                        const roomStatus = await response.json();
                        
                        if (roomStatus.status !== 'active') {
                            clearInterval(roomCheckInterval);
                            closeVideoCall(data.room_id, userId);
                        }
                    } catch (error) {
                        console.error('Ошибка проверки статуса комнаты:', error);
                    }
                }, 5000); // Проверяем каждые 5 секунд
            })
            .catch(error => {
                console.error('Ошибка:', error);
                tg.showAlert('Не удалось создать видеозвонок. Попробуйте позже.');
            });
        }

        function closeVideoCall(roomId, userId) {
            if (jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
            }
            document.getElementById('jitsiContainer').style.display = 'none';

            // Уведомляем сервер о закрытии комнаты
            if (roomId && userId) {
                fetch("https://hmdi-api.onrender.com/end-video-room", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: userId
                    })
                }).catch(console.error);
            }
        }

        async function loadHelpRequests() {
            isLoading = true;
            document.getElementById('loadingRequests').style.display = 'block';
            const requestsContainer = document.getElementById('helpRequests');
            requestsContainer.innerHTML = '';

            try {
                const response = await fetch('https://hmdi-api.onrender.com/get-help-requests');
                const data = await response.json();
                const currentUserId = localStorage.getItem('hmdi_user_id');
                
                if (data.requests && data.requests.length > 0) {
                    data.requests.forEach(request => {
                        // Пропускаем собственные заявки
                        if (request.user_id === currentUserId) {
                            return;
                        }

                        const requestElement = document.createElement('div');
                        requestElement.className = 'list-group-item list-group-item-action mb-2';
                        requestElement.style.cursor = 'pointer';
                        
                        const timeString = new Date(request.created_at).toLocaleString();
                        
                        requestElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1">${request.description}</p>
                                    <small class="text-muted">Создано: ${timeString}</small>
                                </div>
                                <button class="btn btn-outline-primary btn-sm">Помочь</button>
                            </div>
                        `;
                        
                        requestElement.onclick = () => showRequestCard(request);
                        requestsContainer.appendChild(requestElement);
                    });

                    // Если после фильтрации собственных заявок список пуст
                    if (requestsContainer.children.length === 0) {
                        requestsContainer.innerHTML = '<p class="text-center text-muted">Нет активных заявок от других пользователей</p>';
                    }
                } else {
                    requestsContainer.innerHTML = '<p class="text-center text-muted">Нет активных заявок</p>';
                }
            } catch (error) {
                requestsContainer.innerHTML = '<p class="text-center text-danger">Ошибка при загрузке заявок</p>';
                console.error('Error loading requests:', error);
            } finally {
                document.getElementById('loadingRequests').style.display = 'none';
                isLoading = false;
            }
        }
    </script>
</body>

</html>